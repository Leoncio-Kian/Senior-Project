<!DOCTYPE html>
<html>
	<Body>
		<canvas id="drawCanvas" width="800" height="600" style= "border:1px solid #c3c3c3;"></canvas>
		<script src="/socket.io/socket.io.js"></script>
		<script>
		function Whiteboard(canvas, socket) {
			var _canvas = canvas;
			var _ctx = _canvas.getContext('2d');
			var that = this;
			var isActive = false;
			var plots = [];
			var plotIndex = 1;
			var currentColor = 'blue';

			socket.on('whiteboard update', function(msg){
        if(!msg || msg.plots.length < 1) return; 
              
          drawOnCanvas(msg.plots);
      });

			function initialize() {
				
				_canvas.addEventListener('mousedown', startDraw, false);
	      _canvas.addEventListener('mousemove', draw, false);
	      _canvas.addEventListener('mouseup', endDraw, false);
    	}
    	function initializeCtx(color) {
    		_ctx.strokeStyle = color || currentColor;
    		_ctx.lineWidth = '3';
      	_ctx.lineCap = 'round';
      	_ctx.lineJoin = 'round';
    		_ctx.beginPath();
    		console.log(this);
    	}
			function drawOnCanvas(plots) {
               
        for(; plotIndex<plots.length; plotIndex++) {
          _ctx.lineTo(plots[plotIndex].x, plots[plotIndex].y);
        }
        _ctx.stroke();
      }
    	function draw(e) {
    		if(!isActive){
        	return;
    		}
        var x = e.offsetX || e.layerX - canvas.offsetLeft;
        var y = e.offsetY || e.layerY - canvas.offsetTop;

        plots.push({x: x, y: y});

        drawOnCanvas(plots);
        socket.emit('whiteboard update', {'color': color, 'plots': plots});  
      }
          
        
      function startDraw(e) {
      	console.log('started drawing, e is: ', e);
      	initializeCtx('red');
      	var x = e.offsetX || e.layerX - canvas.offsetLeft;
        var y = e.offsetY || e.layerY - canvas.offsetTop;
        console.log(this);
        _ctx.moveTo(x, y);
        isActive = true;
      }
          
      function endDraw(e) {
        console.log('finished drawing!');
        isActive = false;
        plots = [];
        plotIndex = 1;
      }

      initialize();
		}
		console.log(socket);
		var wb = new Whiteboard(document.getElementById('drawCanvas'), socket);


		</script>
	</Body>
</html>
