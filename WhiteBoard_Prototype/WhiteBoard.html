<!DOCTYPE html>
<html>
	<Body>
		<canvas id="drawCanvas" width="800" height="600" style= "border:1px solid #c3c3c3;"></canvas>
		<script src="/socket.io/socket.io.js"></script>
		<script>

			var canvas = document.getElementById('drawCanvas');
			var ctx = canvas.getContext('2d');
			     
			ctx.lineWidth = '3';
			ctx.lineCap = 'round';
			ctx.lineJoin = 'round';3

			var currentColor = 'blue';
			var socket = io();

			var temporaryStorage = [];

			canvas.addEventListener('mousedown', startDraw, false);
			canvas.addEventListener('mousemove', draw, false);
			canvas.addEventListener('mouseup', endDraw, false);
	
			function setupDraw(color){
				ctx.strokeStyle = color;
				ctx.beginPath();		
			}

			function drawOnCanvas(plots) {
			  ctx.moveTo(plots[0].x, plots[0].y);

			  for(var i=1; i<plots.length; i++) {
			    ctx.lineTo(plots[i].x, plots[i].y);
			  }

			  ctx.stroke();
			}
			function finishDraw(){
				var holdLastPos = temporaryStorage[temporaryStorage.length - 1];
				temporaryStorage = [];
			  temporaryStorage.push(holdLastPos);
			}
			
			socket.on('whiteboard update', function(msg){
				if(!msg) return; 
			    console.log(msg);
			  	setupDraw(msg.color);
			  	console.log(msg.plots);
			    drawOnCanvas(msg.plots);
			    finishDraw();
			    setupDraw(msg.color);
			});

			var isActive = false;
			var plotArray = [];
			var start = 0;
			var progress = 0;

			function draw(e) {
			  if(!isActive) return;

			  if (start == 0) start = Date.now();
			  var progress = Date.now() - start;
			  updateArray(e);
			  if (progress > 50) {
			  	
			    drawOnCanvas(temporaryStorage);
			    socket.emit('whiteboard update', {'color': currentColor, 'plots': temporaryStorage});
			    finishDraw();
			    setupDraw(currentColor);
			    start = 0;
			    progress = 0;
			    
			    ctx.beginPath();
			  }
				
			}

			function updateArray(e){
				var x = e.offsetX || e.layerX - canvas.offsetLeft;
			  var y = e.offsetY || e.layerY - canvas.offsetTop;

			  //socket.emit('whiteboard update', {'color': color, 'plots': plotLine, plotArray: plotArray});   
				
				temporaryStorage.push({x: x, y: y});

			}
			    
			function startDraw(e) {
			  isActive = true;
				setupDraw(currentColor);
				temporaryStorage = [];
			}
			    
			function endDraw(e) {
				isActive = false;
				setupDraw(currentColor);
			    drawOnCanvas(temporaryStorage);
			    finishDraw();
				temporaryStorage = [];
			}

			socket.on('initializeWhiteboard', function(msg){
				if(!msg) return; 
					for(var i = 0; i < msg.length; i++){
				    console.log(msg);
				  	setupDraw(msg[i].color);
				  	console.log(msg[i].plots);
				    drawOnCanvas(msg[i].plots);
				    finishDraw();
				    setupDraw(msg[i].color);
			  	}
			});
			</script>




		</script>
	</Body>
</html>
